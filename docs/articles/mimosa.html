<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MIMoSA: A Method for Inter-Modal Segmentation Analysis • mimosa</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="MIMoSA: A Method for Inter-Modal Segmentation Analysis">
<meta property="og:description" content="mimosa">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mimosa</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.8</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/mimosa.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mimosa_git.html">MIMoSA: A Method for Inter-Modal Segmentation Analysis</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/avalcarcel9/mimosa/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>MIMoSA: A Method for Inter-Modal Segmentation Analysis</h1>
                        <h4 class="author">Alessandra Valcarcel</h4>
            
            <h4 class="date">2020-03-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/avalcarcel9/mimosa/blob/master/vignettes/mimosa.Rmd"><code>vignettes/mimosa.Rmd</code></a></small>
      <div class="hidden name"><code>mimosa.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level2">
<h2 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h2>
<p>The mimosa package trains and makes predictions from the MIMoSA method. Access to the full paper can be found <a href="http://www.biorxiv.org/content/early/2017/06/15/150284">here</a>. Additionally, it allows for implementation of some common segmentation metrics such as true positive rate, false positive rate, false negative rate, false positive count, and sensitivity based on lesion count.</p>
<p>Due to constraints with Neuroconductor code and output could not be compiled together. If you would like to follow a vignette with code and relevant output please use the version available on my <a href="https://github.com/avalcarcel9/mimosa/blob/master/vignettes/mimosa.Rmd">github</a>.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>To install the package from neuroconductor, type:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/source.html">source</a></span>(<span class="st">"https://neuroconductor.org/neurocLite.R"</span>)
<span class="fu">neuro_install</span>(<span class="st">"mimosa"</span>)</pre></body></html></div>
<p>To get the latest development version from GitHub:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="kw pkg">devtools</span><span class="kw ns">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">'avalcarcel9/mimosa'</span>)</pre></body></html></div>
<p>When going through this tutorial be sure your package is up to date. You will also need to install and load the following packages:</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">neurobase</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">mimosa</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">dplyr</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">oasis</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">fslr</span>)</pre></body></html></div>
</div>
<div id="tutorial-data" class="section level2">
<h2 class="hasAnchor">
<a href="#tutorial-data" class="anchor"></a>Tutorial Data</h2>
<p>We will be using data from the <a href="https://smart-stats-tools.org/node/26">2015 Longitudinal Multiple Sclerosis Lesion Segmentation Challenge</a>.</p>
<p>The MIMoSA algorithm is most powerful when FLAIR, T1, T2, and PD imaging modalities are provided but the algorithm only needs FLAIR and T1 in order to run. While there is no statistically significant loss is power when reducing the types of imaging modalities there may be changes in qualitative results.</p>
<div id="getting-and-organizing-the-data-for-use" class="section level3">
<h3 class="hasAnchor">
<a href="#getting-and-organizing-the-data-for-use" class="anchor"></a>Getting and organizing the data for use</h3>
<p>After going to <a href="https://smart-stats-tools.org/node/26">2015 Longitudinal Multiple Sclerosis Lesion Segmentation Challenge</a> you will need to create an account in order to download the data. After creating an account, you will receive an email (mine took a little over a day to get) with your login allowing you to set up a password. At this point you can go <a href="https://smart-stats-tools.org/lesion-challenge-2015">here</a> to download the data.</p>
<p>The data consists of a set of training subjects in the training folder for which we have 2 sets of gold standard manual segmentations and 14 test subjects for which there are no gold standard manual segmentations provided. Each subject may have data for multiple time points. After downloading these data, I put the training and testdata_website data into a folder ISBI_Challenge_2015.</p>
<p>For these analysis, we will use the ISBI_Challenge_2015/training/training01/preprocessed data to train the model using the gold standard manually segmented images in ISBI_Challenge_2015/training/masks/training01_0#_mask2.nii. We will then apply the trained model on ISBI_Challenge_2015/testdata_website/test01/preprocessed/ images to generate probability maps and MIMoSA predicted lesion masks. We will also use ISBI_Challenge_2015/training/training02/preprocessed/ data from the first time point to evaluate performance. If you have your own data you can adapt code provided here and apply the methods to your own data. For this reason, all code provided is intended to provide a direct application of methods therefore speed and efficiency were sacrificed in the examples provided.</p>
</div>
<div id="creating-a-file-name-matrix" class="section level3">
<h3 class="hasAnchor">
<a href="#creating-a-file-name-matrix" class="anchor"></a>Creating a file name <code>matrix</code>
</h3>
<p>Before loading the data into R let’s first organize the image file paths into a <code>matrix</code>.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="co"># Note these paths will be to where you </span>
<span class="co"># have stored the data or to your own data</span>
<span class="no">train_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train_data_dir</span>, <span class="st">"training01"</span>)

<span class="no">T1_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="kw">path</span> <span class="kw">=</span>
                        <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train_dir</span>,
                                  <span class="st">"preprocessed"</span>),
                      <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"mprage_pp[.]nii"</span>,
                      <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">T2_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="kw">path</span> <span class="kw">=</span>
                        <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train_dir</span>,
                                  <span class="st">"preprocessed"</span>),
                      <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"t2_pp[.]nii"</span>,
                      <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">FLAIR_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="kw">path</span> <span class="kw">=</span>
                           <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train_dir</span>,
                                     <span class="st">"preprocessed"</span>),
                         <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"flair_pp[.]nii"</span>,
                         <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">PD_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="kw">path</span> <span class="kw">=</span>
                        <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train_dir</span>,
                                  <span class="st">"preprocessed"</span>),
                      <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"pd_pp[.]nii"</span>,
                      <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">GS_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="kw">path</span> <span class="kw">=</span>
                        <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train_dir</span>,
                                  <span class="st">"masks"</span>),
                      <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"mask2[.]nii"</span>,
                      <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">filepaths</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">T1</span> <span class="kw">=</span> <span class="no">T1_files</span>, <span class="kw">T2</span> <span class="kw">=</span> <span class="no">T2_files</span>, <span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">FLAIR_files</span>, <span class="kw">PD</span> <span class="kw">=</span> <span class="no">PD_files</span>, <span class="kw">GS</span> <span class="kw">=</span> <span class="no">GS_files</span>, <span class="kw">stringsAsFactors</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">ss</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/nii.stub.html">nii.stub</a></span>(<span class="no">filepaths</span>$<span class="no">T1</span>), <span class="kw">split</span> <span class="kw">=</span> <span class="st">"_"</span>)
<span class="no">filepaths</span>$<span class="no">visit_id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">ss</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>[<span class="fl">2</span>])
<span class="no">filepaths</span></pre></body></html></div>
</div>
<div id="preprocessing" class="section level3">
<h3 class="hasAnchor">
<a href="#preprocessing" class="anchor"></a>Preprocessing</h3>
<p>The <code>mimosa</code> package does not provide a preprocessing pipeline function. For the preprocessing pipeline used in the original methods please see our <a href="http://www.biorxiv.org/content/early/2017/06/15/150284">paper</a>. Before implementing the method, data should be inhomogeneity corrected, registered, skull stripped, and normalized to obtain accurate predicted lesion segmentations. The training functions in this package allow for z-score normalization, WhiteStripe normalization, or no normalization method for data that have been previously normalized.</p>
<p>Some preprocessing tips:</p>
<p>In the implementation of this method, we notice that the specific preprocessing pipeline does not seem to make a difference so long as each preprocessing step does not fail. In cases with large lesion load, z-score normalization often fails and we suggest using <code>WhiteStripe</code>. In future versions of this package we plan to allow for <code>WhiteStripe</code> normalization.</p>
<p>For this example, data are preprocessed for us. That is, they have been inhomogeneity corrected, registered, and skull stripped. They have not been normalized yet so we will apply z-score normalization through the <code>mimosa</code> package function arguments.</p>
</div>
</div>
<div id="creating-predictors" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-predictors" class="anchor"></a>Creating Predictors</h2>
<p>Once data are preprocessed we can create a <code>data.frame</code> of predictors using the <code>mimosa_data</code> function which creates the training vectors from a single MRI study that has FLAIR, T1, T2, and PD volumes. The user only needs FLAIR and T1 sequences but performance may suffer qualitatively. When training the model binary lesion masks are also required. The function returns a tissue mask, the candidate voxels mask for lesion segmentation, smoothed volumes, and coupling maps. The user may supply already normalized data if they wish to use an alternative normalization method.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="co"># The R package neurobase is needed for the readnii function</span>
<span class="no">T1_training01_01</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">T1</span>[<span class="fl">1</span>])
<span class="no">T2_training01_01</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">T2</span>[<span class="fl">1</span>])
<span class="no">FLAIR_training01_01</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">FLAIR</span>[<span class="fl">1</span>])
<span class="no">PD_training01_01</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">PD</span>[<span class="fl">1</span>])
<span class="no">gold_standard</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">GS</span>[<span class="fl">1</span>])</pre></body></html></div>
<p>Before making the predictor data let’s just visualize the loaded data.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">sequence</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">FLAIR_training01_01</span>,
                <span class="kw">T1</span> <span class="kw">=</span> <span class="no">T1_training01_01</span>,
                <span class="kw">T2</span> <span class="kw">=</span> <span class="no">T2_training01_01</span>,
                <span class="kw">PD</span> <span class="kw">=</span> <span class="no">PD_training01_01</span>)
<span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/multi_overlay.html">multi_overlay</a></span>(<span class="no">sequence</span>,
              <span class="kw">z</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span>(<span class="kw pkg">oro.nifti</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/oro.nifti/man/miscellaneous.html">nsli</a></span>(<span class="no">sequence</span><span class="kw">[[</span><span class="fl">1</span>]])/<span class="fl">2</span>),
              <span class="kw">text</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">sequence</span>),
              <span class="kw">text.y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1.4</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">sequence</span>)),
              <span class="kw">text.cex</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">2.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">sequence</span>))
)
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">sequence</span>)</pre></body></html></div>
<p>Let’s first create a brain mask by taking the union of positive voxels in the T1, T2, PD, and FLAIR. We use the union in order to include all voxels across all images with brain matter. The difference in these is typically only near the skull and will not be important after the selection of candidate voxels. We can then create the training <code>data.frame</code> for the sequence loaded in memory. The preprocessing carried out previously did not normalize the data therefore we will set <code>normalize = 'Z'</code>. We are supplying the brain mask rather than a tissue mask so we set <code>tissue = FALSE</code>. If you supply the tissue mask as the <code>brain_mask</code> you can set <code>tissue = TRUE</code>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">create_brain_mask</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">...</span>) {
  <span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="no">...</span>)
  <span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/check_nifti-methods.html">check_nifti</a></span>(<span class="no">x</span>)
  <span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="no">x</span>, <span class="kw">function</span>(<span class="no">img</span>) {
    <span class="no">img</span> <span class="kw">&gt;</span> <span class="fl">0</span>
  })
  <span class="no">mask</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span>(<span class="st">"|"</span>, <span class="no">x</span>)
  <span class="no">mask</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/datatype.html">datatyper</a></span>(<span class="no">mask</span>)
  <span class="no">mask</span>
}</pre></body></html></div>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># Create a brain mask</span>
<span class="no">brain_mask</span> <span class="kw">=</span> <span class="fu">create_brain_mask</span>(
  <span class="no">T1_training01_01</span>,
  <span class="no">T2_training01_01</span>,
  <span class="no">FLAIR_training01_01</span>,
  <span class="no">PD_training01_01</span>
)

<span class="co"># The mimosa R package is needed to run mimosa_data</span>
<span class="no">mimosa_data</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mimosa_data.html">mimosa_data</a></span>(
  <span class="kw">brain_mask</span> <span class="kw">=</span> <span class="no">brain_mask</span>,
  <span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">FLAIR_training01_01</span>,
  <span class="kw">T1</span> <span class="kw">=</span> <span class="no">T1_training01_01</span>,
  <span class="kw">T2</span> <span class="kw">=</span> <span class="no">T2_training01_01</span>,
  <span class="kw">PD</span> <span class="kw">=</span> <span class="no">PD_training01_01</span>,
  <span class="kw">tissue</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">gold_standard</span> <span class="kw">=</span> <span class="no">gold_standard</span>,
  <span class="kw">normalize</span> <span class="kw">=</span> <span class="st">'Z'</span>,
  <span class="kw">cand_mask</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">slices</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">orientation</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"axial"</span>, <span class="st">"coronal"</span>, <span class="st">"sagittal"</span>),
  <span class="kw">cores</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>A note on the returned objects:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/list.html">is.list</a></span>(<span class="no">mimosa_data</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_data</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_data</span>$<span class="no">smoothed</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_data</span>$<span class="no">smoothed</span>$<span class="no">smooth_10</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_data</span>$<span class="no">smoothed</span>$<span class="no">smooth_20</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_data</span>$<span class="no">coupling_intercepts</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_data</span>$<span class="no">coupling_slopes</span>)
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_data</span>$<span class="no">normalized</span>)</pre></body></html></div>
<p>The following items are always returned from the <code>mimosa_data</code> function:</p>
<ul>
<li>
<code>mimosa_dataframe</code> is the predictor dataframe</li>
<li>
<code>top_voxels</code> is a mask for candidate lesion voxels. This is a binary mask of class <code>nifti</code>.</li>
<li>
<code>smoothed</code> is an embedded list of smoothed volumes. Here there is another set of lists <code>smooth_10</code> and <code>smooth_20</code>. Each object in these lists is a <code>nifti</code>.</li>
<li>
<code>coupling_intercepts</code> is an embedded list of the coupling intercept values inside of the candidate mask. Each object in this list is a <code>nifti</code>.</li>
<li>
<code>coupling_slopes</code> is an embedded list of the coupling slopes inside of the candidate_mask. Each object in this list is a <code>nifti</code>.</li>
</ul>
<p>The following may be returned depending on input arguments:</p>
<ul>
<li>
<code>normalized</code> is an embedded list of normalized volumes. Returned when <code>normalize != 'no'</code>. Each object in this list is a <code>nifti</code>.</li>
<li>
<code>tissue_mask</code> is a brain mask that excludes CSF. Returned when <code>tissue = FALSE</code>. Each object in this list is a <code>nifti</code>.</li>
</ul>
<p>Next, I show the first 5 rows of the <code>$mimosa_dataframe</code> and a few of the nifti objects displayed using <code>ortho2</code>. You can always save these objects using <code>writenii</code> and use a viewer of your choosing.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">mimosa_data</span>$<span class="no">mimosa_dataframe</span>)

<span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/ortho2.html">ortho2</a></span>(<span class="no">mimosa_data</span>$<span class="no">top_voxels</span>)
<span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/ortho2.html">ortho2</a></span>(<span class="no">mimosa_data</span>$<span class="no">smoothed</span>$<span class="no">smooth_10</span>$<span class="no">FLAIR_10</span>)
<span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/ortho2.html">ortho2</a></span>(<span class="no">mimosa_data</span>$<span class="no">coupling_slopes</span>$<span class="no">FLAIRonT1_slopes</span>)

<span class="co"># Remove mimosa_data from memory</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">mimosa_data</span>)</pre></body></html></div>
<p>The <code>mimosa_data$mimosa_dataframe</code> in conjunction with the candidate voxel mask or <code>mimosa_data$top_voxels</code> can be used to generate probability maps which can in turn be thresholded to generate predicted lesion masks.</p>
<p>The <code>mimosa_data$mimosa_dataframe</code> is also used to train the model which we will cover in detail in the next section.</p>
</div>
<div id="train-the-mimosa-model" class="section level2">
<h2 class="hasAnchor">
<a href="#train-the-mimosa-model" class="anchor"></a>Train the MIMoSA Model</h2>
<p>There are two (2) approaches to training the mimosa model. In the first approach we will use the built in <code>mimosa_training</code> function which will create a large predictor matrix for all subjects supplied, train the model, and calculate the optimal threshold. In the second, you can utilize the <code>mimosa_data</code> and <code>mimosa_fit</code> functions to break up this process and train the model yourself. Both approaches yield the same results and therefore choice of approaches comes down to user preference and need. We will first show the approach using <code>mimosa_training</code> and then show an example broken down using the <code>mimosa_data</code> and <code>mimosa_fit</code> approach.</p>
<ol style="list-style-type: decimal">
<li><code>mimosa_training</code></li>
</ol>
<p>Unlike <code>mimosa_data</code> here <code>brain_mask</code>, <code>FLAIR</code>, <code>T1</code>, <code>T2</code>, <code>PD</code>, and <code>gold_standard</code> are vectors of file paths to their respective object. We will use a simple for loop to generate and save the brain masks. You may need to change the <code><a href="https://rdrr.io/r/base/substr.html">substr(filepaths, 74, 78)</a></code> if your file path is different. Again, we note that this is not the most efficient computational approach.</p>
<p>Since we need to supply vectors of file paths and not local objects when applying this function. We will need to create brain masks for each subject and add them to the <code>matrix</code> <code>filepaths</code>. After that, we will use the same arguments as in the <code>mimosa_data</code> example.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">filepaths</span>$<span class="no">brainmask</span> <span class="kw">=</span> <span class="fl">NA</span>

<span class="co"># The neurobase R package is required to read and write images</span>
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">filepaths</span>))) {
  <span class="co"># Load files</span>
  <span class="no">visit_id</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">visit_id</span>[<span class="no">i</span>]
  <span class="no">fname</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train_dir</span>,
                    <span class="st">"preprocessed"</span>,
                    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"brainmask_"</span>,
                           <span class="no">visit_id</span>, <span class="st">".nii.gz"</span>))
  <span class="kw">if</span> (!<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="no">fname</span>)) {
    <span class="no">T1_training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">T1</span>[<span class="no">i</span>])
    <span class="no">T2_training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">T2</span>[<span class="no">i</span>])
    <span class="no">FLAIR_training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">FLAIR</span>[<span class="no">i</span>])
    <span class="no">PD_training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">PD</span>[<span class="no">i</span>])
    <span class="no">brain_mask</span> <span class="kw">=</span> <span class="fu">create_brain_mask</span>(
      <span class="no">T1_training</span>,
      <span class="no">T2_training</span>,
      <span class="no">FLAIR_training</span>,
      <span class="no">PD_training</span>
    )
  <span class="co"># Save brain mask to local working directory</span>
  <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/writeNIfTI2.html">writenii</a></span>(<span class="no">brain_mask</span>,
           <span class="kw">filename</span> <span class="kw">=</span> <span class="no">fname</span>)
  }
  <span class="no">filepaths</span>$<span class="no">brainmask</span>[<span class="no">i</span>] <span class="kw">=</span> <span class="no">fname</span>
}</pre></body></html></div>
<p>Now we have all file paths for the input arguments required for <code>mimosa_training</code>. Let’s apply <code>mimosa_training</code> to train the model. We will set <code>optimal_threshold = seq(0.25, 0.35, 0.01)</code> in order for the optimal thresholding algorithm to calculate the threshold that optimizes DSC compared to gold standard manually segmented images within these supplied values. We will keep <code>outdir = NULL</code> but if you wanted to save all returned objects for all subjects you should specify a vector of file paths with unique IDs.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">mimosa_training</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mimosa_training.html">mimosa_training</a></span>(
  <span class="kw">brain_mask</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">brainmask</span>,
  <span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">FLAIR</span>,
  <span class="kw">T1</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">T1</span>,
  <span class="kw">T2</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">T2</span>,
  <span class="kw">PD</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">PD</span>,
  <span class="kw">tissue</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">gold_standard</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">GS</span>,
  <span class="kw">normalize</span> <span class="kw">=</span> <span class="st">'Z'</span>,
  <span class="kw">slices</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">orientation</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"axial"</span>, <span class="st">"coronal"</span>, <span class="st">"sagittal"</span>),
  <span class="kw">cores</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
  <span class="kw">outdir</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">optimal_threshold</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0.25</span>, <span class="fl">0.35</span>, <span class="fl">0.01</span>))

<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_training</span>)
<span class="no">mimosa_training</span>$<span class="no">mimosa_fit_model</span>
<span class="no">mimosa_training</span>$<span class="no">estimated_optimal_threshold</span></pre></body></html></div>
<p>The following are always returned from <code>mimosa_training</code>:</p>
<ul>
<li>
<code>mimosa_fit_model</code> which is the trained MIMoSA model to be applied to test data</li>
<li>
<code>estimated_optimal_threshold</code> which is the optimal threshold using our optimal thresholding algorithm</li>
</ul>
<p>The following may be returned to the specified directory from <code>outdir</code> (not locally in R) from <code>mimosa_training</code>:</p>
<ul>
<li>The <code>mimosa_dataframe</code> for each subject.</li>
<li>The <code>top_voxels</code> for each subject.</li>
<li>The <code>smoothed</code> volumes in <code>smooth_10</code> and <code>smooth_20</code> for each modality.</li>
<li>The <code>coupling_intercepts</code> volumes for all coupling combinations.</li>
<li>The <code>coupling_slopes</code> volumes for all coupling combinations.</li>
</ul>
<p>To obtain these data, set <code>outdir = NULL</code> to a vector of paths which include subject ID. For example, “/path/to/results/ID#_” where the specific “ID#” would be different creating a vector to be input.</p>
<ol start="2" style="list-style-type: decimal">
<li>
<code>mimosa_data</code> and <code>mimosa_fit</code>
</li>
</ol>
<p>When using <code>mimosa_data</code> remember we are using local <code>nifti</code> objects for <code>brain_mask</code>, <code>FLAIR</code>, <code>T1</code>, <code>T2</code>, <code>PD</code>, and <code>gold_standard</code> not vectors of file paths like <code>mimosa_training</code>. In this example we will again use a simple for loop to generate the predictor <code>data.frame</code> needed for training. Again, we note that this is not the most efficient computational approach.</p>
<p>Since we only need the predictors <code>data.frame</code> which is returned as <code>$mimosa_dataframe</code> we store only the <code>data.frame</code> in a list.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="co"># Initialize an empty list</span>
<span class="no">mimosa_df_list</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span>(<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"list"</span>,
  <span class="kw">length</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">filepaths</span>))
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="no">mimosa_df_list</span>) <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">visit_id</span>

<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">filepaths</span>))) {
  <span class="co"># Load files</span>
  <span class="no">T1_training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">T1</span>[<span class="no">i</span>])
  <span class="no">T2_training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">T2</span>[<span class="no">i</span>])
  <span class="no">FLAIR_training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">FLAIR</span>[<span class="no">i</span>])
  <span class="no">PD_training</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">PD</span>[<span class="no">i</span>])
  <span class="no">gold_standard</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">GS</span>[<span class="no">i</span>])
  <span class="no">brain_mask</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">brainmask</span>[<span class="no">i</span>])
  <span class="co"># Obtain the mimosa predictor data.frame</span>

  <span class="no">mimosa_df_list</span><span class="kw">[[</span><span class="no">i</span>]] <span class="kw">=</span> <span class="fu"><a href="../reference/mimosa_data.html">mimosa_data</a></span>(
    <span class="kw">brain_mask</span> <span class="kw">=</span> <span class="no">brain_mask</span>,
    <span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">FLAIR_training</span>,
    <span class="kw">T1</span> <span class="kw">=</span> <span class="no">T1_training</span>,
    <span class="kw">T2</span> <span class="kw">=</span> <span class="no">T2_training</span>,
    <span class="kw">PD</span> <span class="kw">=</span> <span class="no">PD_training</span>,
    <span class="kw">tissue</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
    <span class="kw">gold_standard</span> <span class="kw">=</span> <span class="no">gold_standard</span>,
    <span class="kw">normalize</span> <span class="kw">=</span> <span class="st">'Z'</span>,
    <span class="kw">cand_mask</span> <span class="kw">=</span> <span class="kw">NULL</span>,
    <span class="kw">slices</span> <span class="kw">=</span> <span class="kw">NULL</span>,
    <span class="kw">orientation</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"axial"</span>, <span class="st">"coronal"</span>, <span class="st">"sagittal"</span>),
    <span class="kw">cores</span> <span class="kw">=</span> <span class="fl">1</span>,
    <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>)$<span class="no">mimosa_dataframe</span>
}
<span class="co"># Turn list into a single data.frame which has all subjects predictor data.frames</span>
<span class="no">mimosa_df</span> <span class="kw">=</span> <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>(<span class="no">mimosa_df_list</span>, <span class="kw">.id</span> <span class="kw">=</span> <span class="st">"visit_id"</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">mimosa_df</span>)
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span>(<span class="no">mimosa_df</span>)</pre></body></html></div>
<p>As you can see the <code>data.frame</code> is very large and only contains a few subjects. In cases where you have a full dataset this may be extremely large and it is useful to store individual <code>data.frames</code> separately to a directory or all together in a list rather than a giant <code>data.frame</code>. The <code>data.frame</code> is now ready to train the MIMoSA model.</p>
<p>Let’s use <code>mimosa_fit</code> to train the model. We will need to input a formula here for the model. The formula will depend on which image modalities you are using.</p>
<p>If you have T1, T2, FLAIR, PD:</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">formula</span> <span class="kw">=</span> <span class="no">gold_standard</span> ~ <span class="no">FLAIR_10</span> * <span class="no">FLAIR</span> + <span class="no">FLAIR_20</span> * <span class="no">FLAIR</span> +
  <span class="no">PD_10</span> * <span class="no">PD</span> + <span class="no">PD_20</span> * <span class="no">PD</span> +
  <span class="no">T2_10</span> * <span class="no">T2</span> + <span class="no">T2_20</span> * <span class="no">T2</span> +
  <span class="no">T1_10</span> * <span class="no">T1</span> + <span class="no">T1_20</span> * <span class="no">T1</span> +
  <span class="no">FLAIRonT1_intercepts</span> + <span class="no">FLAIRonT2_intercepts</span> + <span class="no">FLAIRonPD_intercepts</span> +
  <span class="no">T1onT2_intercepts</span> + <span class="no">T1onPD_intercepts</span> + <span class="no">T2onPD_intercepts</span> +
  <span class="no">T1onFLAIR_intercepts</span> + <span class="no">T2onFLAIR_intercepts</span> + <span class="no">PDonFLAIR_intercepts</span> +
  <span class="no">T2onT1_intercepts</span> + <span class="no">PDonT1_intercepts</span> + <span class="no">PDonT2_intercepts</span> +
  <span class="no">FLAIRonT1_slopes</span> + <span class="no">FLAIRonT2_slopes</span> + <span class="no">FLAIRonPD_slopes</span> +
  <span class="no">T1onT2_slopes</span> + <span class="no">T1onPD_slopes</span> + <span class="no">T2onPD_slopes</span> +
  <span class="no">T1onFLAIR_slopes</span> + <span class="no">T2onFLAIR_slopes</span> + <span class="no">PDonFLAIR_slopes</span> +
  <span class="no">T2onT1_slopes</span> + <span class="no">PDonT1_slopes</span> + <span class="no">PDonT2_slopes</span></pre></body></html></div>
<p>If you have T1, T2, FLAIR:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="no">formula</span> <span class="kw">=</span> <span class="no">gold_standard</span> ~ <span class="no">FLAIR_10</span> * <span class="no">FLAIR</span> + <span class="no">FLAIR_20</span> * <span class="no">FLAIR</span> +
  <span class="no">T2_10</span> * <span class="no">T2</span> + <span class="no">T2_20</span> * <span class="no">T2</span> +
  <span class="no">T1_10</span> * <span class="no">T1</span> + <span class="no">T1_20</span> * <span class="no">T1</span> +
  <span class="no">FLAIRonT1_intercepts</span> + <span class="no">FLAIRonT2_intercepts</span> +
  <span class="no">T1onT2_intercepts</span> + <span class="no">T1onFLAIR_intercepts</span> +
  <span class="no">T2onFLAIR_intercepts</span> + <span class="no">T2onT1_intercepts</span> +
  <span class="no">FLAIRonT1_slopes</span> + <span class="no">FLAIRonT2_slopes</span> +
  <span class="no">T1onT2_slopes</span> + <span class="no">T1onFLAIR_slopes</span> +
  <span class="no">T2onFLAIR_slopes</span> + <span class="no">T2onT1_slopes</span></pre></body></html></div>
<p>If you have T1, FLAIR, PD:</p>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">formula</span> <span class="kw">=</span> <span class="no">gold_standard</span> ~ <span class="no">FLAIR_10</span> * <span class="no">FLAIR</span> + <span class="no">FLAIR_20</span> * <span class="no">FLAIR</span> +
  <span class="no">PD_10</span> * <span class="no">PD</span> + <span class="no">PD_20</span> * <span class="no">PD</span> +
  <span class="no">T1_10</span> * <span class="no">T1</span> + <span class="no">T1_20</span> * <span class="no">T1</span> +
  <span class="no">FLAIRonT1_intercepts</span> + <span class="no">FLAIRonPD_intercepts</span> +
  <span class="no">T1onPD_intercepts</span> + <span class="no">T1onFLAIR_intercepts</span> +
  <span class="no">PDonFLAIR_intercepts</span> + <span class="no">PDonT1_intercepts</span> +
  <span class="no">FLAIRonT1_slopes</span> + <span class="no">FLAIRonPD_slopes</span> +
  <span class="no">T1onPD_slopes</span> + <span class="no">T1onFLAIR_slopes</span> +
  <span class="no">PDonFLAIR_slopes</span> + <span class="no">PDonT1_slopes</span></pre></body></html></div>
<p>If you have T1, FLAIR:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">formula</span> <span class="kw">=</span> <span class="no">gold_standard</span> ~ <span class="no">FLAIR_10</span> * <span class="no">FLAIR</span> + <span class="no">FLAIR_20</span> * <span class="no">FLAIR</span> +
  <span class="no">T1_10</span> * <span class="no">T1</span> + <span class="no">T1_20</span> * <span class="no">T1</span> +
  <span class="no">FLAIRonT1_intercepts</span> + <span class="no">T1onFLAIR_intercepts</span> +
  <span class="no">FLAIRonT1_slopes</span> + <span class="no">T1onFLAIR_slopes</span></pre></body></html></div>
<p>Here we have all images so we will use the full formula.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">formula</span> <span class="kw">=</span> <span class="no">gold_standard</span> ~ <span class="no">FLAIR_10</span> * <span class="no">FLAIR</span> + <span class="no">FLAIR_20</span> * <span class="no">FLAIR</span> +
  <span class="no">PD_10</span> * <span class="no">PD</span> + <span class="no">PD_20</span> * <span class="no">PD</span> +
  <span class="no">T2_10</span> * <span class="no">T2</span> + <span class="no">T2_20</span> * <span class="no">T2</span> +
  <span class="no">T1_10</span> * <span class="no">T1</span> + <span class="no">T1_20</span> * <span class="no">T1</span> +
  <span class="no">FLAIRonT1_intercepts</span> + <span class="no">FLAIRonT2_intercepts</span> + <span class="no">FLAIRonPD_intercepts</span> +
  <span class="no">T1onT2_intercepts</span> + <span class="no">T1onPD_intercepts</span> + <span class="no">T2onPD_intercepts</span> +
  <span class="no">T1onFLAIR_intercepts</span> + <span class="no">T2onFLAIR_intercepts</span> + <span class="no">PDonFLAIR_intercepts</span> +
  <span class="no">T2onT1_intercepts</span> + <span class="no">PDonT1_intercepts</span> + <span class="no">PDonT2_intercepts</span> +
  <span class="no">FLAIRonT1_slopes</span> + <span class="no">FLAIRonT2_slopes</span> + <span class="no">FLAIRonPD_slopes</span> +
  <span class="no">T1onT2_slopes</span> + <span class="no">T1onPD_slopes</span> + <span class="no">T2onPD_slopes</span> +
  <span class="no">T1onFLAIR_slopes</span> + <span class="no">T2onFLAIR_slopes</span> + <span class="no">PDonFLAIR_slopes</span> +
  <span class="no">T2onT1_slopes</span> + <span class="no">PDonT1_slopes</span> + <span class="no">PDonT2_slopes</span>

<span class="no">mimosa_model</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mimosa_fit.html">mimosa_fit</a></span>(<span class="no">mimosa_df</span>, <span class="kw">formula</span> <span class="kw">=</span> <span class="no">formula</span>)

<span class="no">mimosa_model</span></pre></body></html></div>
<p>Notice the model here is the same as the one obtained using <code>mimosa_training</code>. The model is now ready to be applied to test data.</p>
</div>
<div id="apply-to-test-subjects" class="section level2">
<h2 class="hasAnchor">
<a href="#apply-to-test-subjects" class="anchor"></a>Apply to Test Subjects</h2>
<p>We can apply the model to test subjects to generate probability maps and lesion segmentation masks. To do this we will generate the predictor <code>data.frame</code> using <code>mimosa_data</code> and then also save the <code>top_voxels</code> object returned. We will then apply the model.</p>
<p>First let’s obtain the file paths for the test subject so we can load the images into R and run <code>mimosa_data</code>.</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="co"># The neurobase and mimosa R packages are required for this chunk</span>
<span class="co"># Note these paths will be to where you have stored the data or to your own data</span>
<span class="no">test_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">test_data_dir</span>, <span class="st">"test01"</span>)

<span class="no">T1_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
  <span class="kw">path</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">test_dir</span>, <span class="st">"preprocessed"</span>),
                      <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"mprage_pp[.]nii"</span>,
                      <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">T2_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
    <span class="kw">path</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">test_dir</span>, <span class="st">"preprocessed"</span>),
                      <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"t2_pp[.]nii"</span>,
                      <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">FLAIR_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
    <span class="kw">path</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">test_dir</span>, <span class="st">"preprocessed"</span>),
                         <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"flair_pp[.]nii"</span>,
                         <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">PD_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
    <span class="kw">path</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">test_dir</span>, <span class="st">"preprocessed"</span>),
                      <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"pd_pp[.]nii"</span>,
                      <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">filepaths</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">T1</span> <span class="kw">=</span> <span class="no">T1_files</span>, <span class="kw">T2</span> <span class="kw">=</span> <span class="no">T2_files</span>,
  <span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">FLAIR_files</span>, <span class="kw">PD</span> <span class="kw">=</span> <span class="no">PD_files</span>,
  <span class="kw">stringsAsFactors</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">filepaths</span>

<span class="co"># Load first subject into R</span>
<span class="no">T1_testing</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">T1</span>[<span class="fl">1</span>])
<span class="no">T2_testing</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">T2</span>[<span class="fl">1</span>])
<span class="no">FLAIR_testing</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">FLAIR</span>[<span class="fl">1</span>])
<span class="no">PD_testing</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">filepaths</span>$<span class="no">PD</span>[<span class="fl">1</span>])

<span class="co"># Create a brain mask</span>
<span class="co"># Create a brain mask</span>
<span class="no">brain_mask</span> <span class="kw">=</span> <span class="fu">create_brain_mask</span>(
  <span class="no">T1_testing</span>,
  <span class="no">T2_testing</span>,
  <span class="no">FLAIR_testing</span>,
  <span class="no">PD_testing</span>
)

<span class="no">mimosa_testdata</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mimosa_data.html">mimosa_data</a></span>(
  <span class="kw">brain_mask</span> <span class="kw">=</span> <span class="no">brain_mask</span>,
  <span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">FLAIR_training</span>,
  <span class="kw">T1</span> <span class="kw">=</span> <span class="no">T1_training</span>,
  <span class="kw">T2</span> <span class="kw">=</span> <span class="no">T2_training</span>,
  <span class="kw">PD</span> <span class="kw">=</span> <span class="no">PD_training</span>,
  <span class="kw">tissue</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">gold_standard</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">normalize</span> <span class="kw">=</span> <span class="st">'Z'</span>,
  <span class="kw">cand_mask</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">slices</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">orientation</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"axial"</span>, <span class="st">"coronal"</span>, <span class="st">"sagittal"</span>),
  <span class="kw">cores</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">mimosa_testdata_df</span> <span class="kw">=</span> <span class="no">mimosa_testdata</span>$<span class="no">mimosa_dataframe</span>
<span class="no">mimosa_candidate_mask</span> <span class="kw">=</span> <span class="no">mimosa_testdata</span>$<span class="no">top_voxels</span>

<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">T1_files</span>, <span class="no">T2_files</span>, <span class="no">FLAIR_files</span>, <span class="no">PD_files</span>,
  <span class="no">mimosa_testdata</span>)</pre></body></html></div>
<p>We can now generate probability maps.</p>
</div>
<div id="generate-probability-maps" class="section level2">
<h2 class="hasAnchor">
<a href="#generate-probability-maps" class="anchor"></a>Generate Probability Maps</h2>
<p>We will use the <code>mimosa_model</code> to generate probability maps. First we must predict and then we smooth the probability map using adjacent voxel probabilities.</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="co"># The R package fslr is required to smooth the probability map</span>
<span class="no">predictions</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">mimosa_model</span>,
                      <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">mimosa_testdata_df</span>,
                      <span class="kw">type</span> <span class="kw">=</span> <span class="st">'response'</span>)
<span class="no">probability_map</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/niftiarr.html">niftiarr</a></span>(<span class="no">brain_mask</span>, <span class="fl">0</span>)
<span class="no">probability_map</span>[<span class="no">mimosa_candidate_mask</span> <span class="kw">==</span> <span class="fl">1</span>] <span class="kw">=</span> <span class="no">predictions</span>

<span class="no">probability_map</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/fslr/man/fslsmooth.html">fslsmooth</a></span>(<span class="no">probability_map</span>,
                            <span class="kw">sigma</span> <span class="kw">=</span> <span class="fl">1.25</span>,
                            <span class="kw">mask</span> <span class="kw">=</span> <span class="no">brain_mask</span>,
                            <span class="kw">retimg</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                            <span class="kw">smooth_mask</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
<p>To visualize the probability map let’s use the <code>ortho2</code> function.</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/ortho2.html">ortho2</a></span>(<span class="no">probability_map</span>)</pre></body></html></div>
</div>
<div id="generate-predicted-lesion-masks" class="section level2">
<h2 class="hasAnchor">
<a href="#generate-predicted-lesion-masks" class="anchor"></a>Generate Predicted Lesion Masks</h2>
<p>We are now ready to threshold the probability map to create binary lesion segmentations. We will use the <code>mimosa_training$estimated_optimal_threshold</code> as the threshold. The user can also specify their own threshold if they choose.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="no">threshold</span> <span class="kw">=</span> <span class="no">mimosa_training</span>$<span class="no">estimated_optimal_threshold</span>
<span class="no">segmentation_mask</span> <span class="kw">=</span> <span class="no">probability_map</span> <span class="kw">&gt;</span> <span class="no">threshold</span>

<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">probability_map</span>)</pre></body></html></div>
<p>Now let’s visualize the masks in a few different ways using <code>ortho2</code>.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/ortho2.html">ortho2</a></span>(<span class="no">segmentation_mask</span>)

<span class="co"># The R package scales is needed for a few of the next commands</span>
<span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/double_ortho.html">double_ortho</a></span>(<span class="no">FLAIR_testing</span>, <span class="no">segmentation_mask</span>, <span class="kw">col.y</span> <span class="kw">=</span> <span class="st">'red'</span>)
<span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/ortho2.html">ortho2</a></span>(<span class="no">FLAIR_testing</span>, <span class="no">segmentation_mask</span>,
  <span class="kw">col.y</span> <span class="kw">=</span> <span class="st">"#FF000080"</span>)

<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span>(<span class="no">segmentation_mask</span>)</pre></body></html></div>
</div>
<div id="evaluate-performance" class="section level2">
<h2 class="hasAnchor">
<a href="#evaluate-performance" class="anchor"></a>Evaluate Performance</h2>
<p>If you are evaluating the performance of a segmentation using a gold standard manual segmentation or otherwise you can use the <code>count_stats</code> function to provide some summary measures of performance. This function will calculate and returns the true positive rate (TPR), false positive rate (FPR), false negative rate (FNR), false positive count (FPC), and sensitivity (S) based on the lesion count.</p>
<p>These metrics are not explicitly defined in the literature so formulas of their calculate are shown.</p>
<p><span class="math display">\[\text{True Positive Rate} = \dfrac{\text{Number of Predicted Lesions that Overlap Gold Standard}}{\text{Gold Standard Count}}\]</span></p>
<p><span class="math display">\[\text{False Positive Rate} = \dfrac{\text{Number of False Positives}}{\text{Predicted Lesion Mask Count}}\]</span></p>
<p><span class="math display">\[\text{False Negative Rate} = \dfrac{\text{Number of False Negatives}}{\text{Gold Standard Count}}\]</span></p>
<p>where here you can specify a proportion of overlap <code>percent_overlap</code> required to count the predicted lesion as truly overlapping the gold standard.</p>
<p><span class="math display">\[\text{False Positive Count} = \text{Number of Lesion in Predicted Mask Not Overlapping A Gold Standard Lesion}\]</span></p>
<p><span class="math display">\[\text{Sensitivity} = \dfrac{\text{True Positive Rate}}{\text{True Positive Rate} + \text{False Negative Rate}}\]</span></p>
<p>Let’s show an example of applying <code>count_stats</code>. For this let’s use the training data again since we have gold standard segmentations to compare our predicted segmentations. We will use the <code>mimosa_model</code> trained in previous steps to generate probability maps and predicted lesion segmentation masks.</p>
<p>For this, let’s only use the training01 subject data and only the first time point.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="no">train2_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train_data_dir</span>, <span class="st">"training02"</span>)

<span class="co"># Read in images</span>
<span class="no">T1_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
  <span class="kw">path</span> <span class="kw">=</span>
    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train2_dir</span>,
              <span class="st">"preprocessed"</span>),
  <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"mprage_pp[.]nii"</span>,
  <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">T2_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
  <span class="kw">path</span> <span class="kw">=</span>
    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train2_dir</span>,
              <span class="st">"preprocessed"</span>),
  <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"t2_pp[.]nii"</span>,
  <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">FLAIR_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
  <span class="kw">path</span> <span class="kw">=</span>
    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train2_dir</span>,
              <span class="st">"preprocessed"</span>),
  <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"flair_pp[.]nii"</span>,
  <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">PD_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
  <span class="kw">path</span> <span class="kw">=</span>
    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train2_dir</span>,
              <span class="st">"preprocessed"</span>),
  <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"pd_pp[.]nii"</span>,
  <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">GS_files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(
  <span class="kw">path</span> <span class="kw">=</span>
    <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">train2_dir</span>,
              <span class="st">"masks"</span>),
  <span class="kw">pattern</span> <span class="kw">=</span> <span class="st">"mask2[.]nii"</span>,
  <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">filepaths</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">T1</span> <span class="kw">=</span> <span class="no">T1_files</span>, <span class="kw">T2</span> <span class="kw">=</span> <span class="no">T2_files</span>, <span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">FLAIR_files</span>, <span class="kw">PD</span> <span class="kw">=</span> <span class="no">PD_files</span>, <span class="kw">GS</span> <span class="kw">=</span> <span class="no">GS_files</span>, <span class="kw">stringsAsFactors</span> <span class="kw">=</span> <span class="fl">FALSE</span>)
<span class="no">ss</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/nii.stub.html">nii.stub</a></span>(<span class="no">filepaths</span>$<span class="no">T1</span>), <span class="kw">split</span> <span class="kw">=</span> <span class="st">"_"</span>)
<span class="no">filepaths</span>$<span class="no">visit_id</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="no">ss</span>, <span class="kw">function</span>(<span class="no">x</span>) <span class="no">x</span>[<span class="fl">2</span>])
<span class="no">filepaths</span>

<span class="no">T1</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">T1</span>[<span class="fl">1</span>]
<span class="no">T2</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">T2</span>[<span class="fl">1</span>]
<span class="no">FLAIR</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">FLAIR</span>[<span class="fl">1</span>]
<span class="no">PD</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">PD</span>[<span class="fl">1</span>]
<span class="no">gold_standard</span> <span class="kw">=</span> <span class="no">filepaths</span>$<span class="no">GS</span>[<span class="fl">1</span>]

<span class="co"># Create a brain mask</span>
<span class="no">brain_mask</span> <span class="kw">=</span> <span class="fu">create_brain_mask</span>(
  <span class="no">T1</span>,
  <span class="no">T2</span>,
  <span class="no">FLAIR</span>,
  <span class="no">PD</span>
)

<span class="co"># Obtain predictor matrix</span>
<span class="no">training02_01_data</span> <span class="kw">=</span> <span class="fu"><a href="../reference/mimosa_data.html">mimosa_data</a></span>(
  <span class="kw">brain_mask</span> <span class="kw">=</span> <span class="no">brain_mask</span>,
  <span class="kw">FLAIR</span> <span class="kw">=</span> <span class="no">FLAIR</span>,
  <span class="kw">T1</span> <span class="kw">=</span> <span class="no">T1</span>,
  <span class="kw">T2</span> <span class="kw">=</span> <span class="no">T2</span>,
  <span class="kw">PD</span> <span class="kw">=</span> <span class="no">PD</span>,
  <span class="kw">tissue</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
  <span class="kw">gold_standard</span> <span class="kw">=</span> <span class="no">gold_standard</span>,
  <span class="kw">normalize</span> <span class="kw">=</span> <span class="st">'Z'</span>,
  <span class="kw">cand_mask</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">slices</span> <span class="kw">=</span> <span class="kw">NULL</span>,
  <span class="kw">orientation</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"axial"</span>, <span class="st">"coronal"</span>, <span class="st">"sagittal"</span>),
  <span class="kw">cores</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># Create predictions based on trained model</span>
<span class="no">predictions</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(<span class="no">mimosa_model</span>,
                      <span class="kw">newdata</span> <span class="kw">=</span> <span class="no">training02_01_data</span>$<span class="no">mimosa_dataframe</span>,
                      <span class="kw">type</span> <span class="kw">=</span> <span class="st">'response'</span>)

<span class="co"># Create a probability map</span>
<span class="no">probability_map</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/niftiarr.html">niftiarr</a></span>(<span class="no">brain_mask</span>, <span class="fl">0</span>)
<span class="no">probability_map</span>[<span class="no">training02_01_data</span>$<span class="no">top_voxels</span> <span class="kw">==</span> <span class="fl">1</span>] <span class="kw">=</span> <span class="no">predictions</span>

<span class="no">probability_map</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/fslr/man/fslsmooth.html">fslsmooth</a></span>(<span class="no">probability_map</span>,
                            <span class="kw">sigma</span> <span class="kw">=</span> <span class="fl">1.25</span>,
                            <span class="kw">mask</span> <span class="kw">=</span> <span class="no">brain_mask</span>,
                            <span class="kw">retimg</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                            <span class="kw">smooth_mask</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># Threshold probability map to create segmentation mask</span>
<span class="no">threshold</span> <span class="kw">=</span> <span class="no">mimosa_training</span>$<span class="no">estimated_optimal_threshold</span>
<span class="no">segmentation_mask</span> <span class="kw">=</span> <span class="no">probability_map</span> <span class="kw">&gt;</span> <span class="no">threshold</span>

<span class="no">gold_standard</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/neurobase/man/readNIfTI2.html">readnii</a></span>(<span class="no">gold_standard</span>)
<span class="co"># Generate summary measures for performance</span>
<span class="fu"><a href="../reference/count_stats.html">count_stats</a></span>(<span class="kw">gold_standard</span> <span class="kw">=</span> <span class="no">gold_standard</span>,
            <span class="kw">predicted_segmentation</span> <span class="kw">=</span> <span class="no">segmentation_mask</span>,
            <span class="kw">k</span> <span class="kw">=</span> <span class="fl">27</span>,
            <span class="kw">percent_overlap</span> <span class="kw">=</span> <span class="fl">0.2</span>,
            <span class="kw">verbose</span> <span class="kw">=</span> <span class="fl">TRUE</span>)</pre></body></html></div>
</div>
<div id="pre-trained-models" class="section level2">
<h2 class="hasAnchor">
<a href="#pre-trained-models" class="anchor"></a>Pre-Trained Models</h2>
<p>The method performs best when trained on data. Since gold standard manual segmentations are not always delineated though through the mimosa package we have trained four (4) distinct models for use. These models can be called and are stored under the following names:</p>
<ul>
<li>mimosa_model trained using FLAIR, T1, T2, and PD imaging modalities</li>
<li>mimosa_model_No_PD trained using FLAIR, T1, and T2 imaging modalities</li>
<li>mimosa_model_No_T2 trained using FLAIR, T1, and PD imaging modalities</li>
<li>mimosa_model_No_PD_T2 trained using FLAIR and T1 imaging modalities</li>
</ul>
<p>Since this model is already trained you can skip the “Train the MIMoSA Model” section and go straight to “Apply to Test Subjects” through “Generate Predicted Lesion Masks” and you can obtain predicted lesion masks. This is because in the “Train the MIMoSA Model” section we generated a model <code>mimosa_model</code> and the fully trained model available through the package is also named <code>mimosa_model</code>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Alessandra Valcarcel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
